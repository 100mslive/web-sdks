name: Lint, Test and Build
on: [push]
jobs:
  build:
    name: Node ${{ matrix.node }} and ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        node: ['16.x']
        os: [ubuntu-latest]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Use Node ${{ matrix.node }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node }}

      - name: yarn packages cache
        uses: actions/cache@v2
        with:
          path: |
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install packages
        run: yarn install --frozen-lockfile

      - name: Lint
        run: yarn lint

      - name: Test
        run: yarn test

      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@v1
        if: github.ref == 'main' || github.ref == 'production'
        with:
          token: ${{ secrets.DOCKER_GIT_TOKEN }}
          event-type: automation
          repository: 100mslive/playwright-automation

      - name: Build for QA
        if: github.ref == 'main' || github.ref == 'feat/WEB-1119'
        run: yarn build
        env:
          REACT_APP_TILE_SHAPE: '1-1'
          REACT_APP_THEME: 'dark'
          REACT_APP_COLOR: '#2F80FF'
          REACT_APP_LOGO: ''
          REACT_APP_FONT: 'Roboto'
          REACT_APP_TOKEN_GENERATION_ENDPOINT: 'https://qa-in2.100ms.live/hmsapi/get-token/'
          REACT_APP_ENV: 'qa'
          REACT_APP_LOGROCKET_ID: ${{ secrets.LOGROCKET_ID }}
          REACT_APP_POLICY_CONFIG: ''
          REACT_APP_WEBINAR_PROPS: '{}'
          REACT_APP_DEFAULT_APP_DETAILS: '{}'
          ENABLE_ROOT_PATH_BUILD_CACHE: '1'
          REACT_APP_PUSHER_APP_KEY: ${{ secrets.PUSHER_KEY }}
          REACT_APP_AMBIENT_MUSIC: 'https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/Together+With+You.mp3'
          REACT_APP_PUSHER_AUTHENDPOINT: 'https://whiteboard-server.vercel.app/api/pusher/auth'
          REACT_APP_LOGROCKET_BLACKLIST: 'peakperformerapp.app.100ms.live,callrockethealth.app.100ms.live,buyume1.app.100ms.live,automation.app.100ms.live,juniorkoder.app.100ms.live,qaroy1.qa-app.100ms.live,kluster.app.100ms.live,pankhuriapp.app.100ms.live,qaroy1.qa-app.100ms.live'
          REACT_APP_PORTRAIT_MODE_DOMAINS: 'whatmorelive-stage.app.100ms.live,arjun.app.100ms.live,koo.app.100ms.live,socialjawn.app.100ms.live'
          REACT_APP_AUDIO_PLAYLIST: '[{"name":"Audio1","id":"audio1","metadata":{"description":"Artist1"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/audio1.mp3","type":"audio"},{"name":"Audio2","id":"audio2","metadata":{"description":"Artist2"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/audio2.mp3","type":"audio"},{"name":"Audio3","id":"audio3","metadata":{"description":"Artist3"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/audio3.mp3","type":"audio"},{"name":"Audio4","id":"audio4","metadata":{"description":"Artist4"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/audio4.mp3","type":"audio"}]'
          REACT_APP_VIDEO_PLAYLIST: '[{"name":"100ms-360P","id":"video1","metadata":{"description":"100ms"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/100ms-360p.mp4","type":"video"},{"name":"100ms-720P","id":"video2","metadata":{"description":"100ms"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/100ms-720p.mp4","type":"video"},{"name":"Big Buck Bunny","id":"video3","metadata":{"description":"Bunny"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/video2.mp4","type":"video"}]'
          REACT_APP_HEADLESS_JOIN: false
          REACT_APP_ENABLE_STATS_FOR_NERDS: 'true'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        if: github.ref == 'main' || github.ref == 'feat/WEB-1119'
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          aws-region: ${{ secrets.S3_BUCKET_REGION }}

      - name: Upload to QA S3 Bucket
        if: github.ref == 'main' || github.ref == 'feat/WEB-1119'
        env:
          BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          aws s3 sync build s3://$BUCKET --include "static/*"
          aws s3 sync build s3://$BUCKET --exclude "static/*"

      - name: Build for Production
        if: github.ref == 'production'
        run: yarn build
        env:
          REACT_APP_TILE_SHAPE: '1-1'
          REACT_APP_THEME: 'dark'
          REACT_APP_COLOR: '#2F80FF'
          REACT_APP_LOGO: ''
          REACT_APP_FONT: 'Roboto'
          REACT_APP_TOKEN_GENERATION_ENDPOINT: 'https://prod-in2.100ms.live/hmsapi/get-token/'
          REACT_APP_ENV: 'qa'
          REACT_APP_LOGROCKET_ID: ${{ secrets.LOGROCKET_ID }}
          REACT_APP_POLICY_CONFIG: ''
          REACT_APP_WEBINAR_PROPS: '{}'
          REACT_APP_DEFAULT_APP_DETAILS: '{}'
          ENABLE_ROOT_PATH_BUILD_CACHE: '1'
          REACT_APP_PUSHER_APP_KEY: ${{ secrets.PUSHER_KEY }}
          REACT_APP_AMBIENT_MUSIC: 'https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/Together+With+You.mp3'
          REACT_APP_PUSHER_AUTHENDPOINT: 'https://whiteboard-server.vercel.app/api/pusher/auth'
          REACT_APP_LOGROCKET_BLACKLIST: 'peakperformerapp.app.100ms.live,callrockethealth.app.100ms.live,buyume1.app.100ms.live,automation.app.100ms.live,juniorkoder.app.100ms.live,qaroy1.qa-app.100ms.live,kluster.app.100ms.live,pankhuriapp.app.100ms.live,qaroy1.qa-app.100ms.live'
          REACT_APP_PORTRAIT_MODE_DOMAINS: 'whatmorelive-stage.app.100ms.live,arjun.app.100ms.live,koo.app.100ms.live,socialjawn.app.100ms.live'
          REACT_APP_AUDIO_PLAYLIST: '[{"name":"Audio1","id":"audio1","metadata":{"description":"Artist1"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/audio1.mp3","type":"audio"},{"name":"Audio2","id":"audio2","metadata":{"description":"Artist2"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/audio2.mp3","type":"audio"},{"name":"Audio3","id":"audio3","metadata":{"description":"Artist3"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/audio3.mp3","type":"audio"},{"name":"Audio4","id":"audio4","metadata":{"description":"Artist4"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/audio4.mp3","type":"audio"}]'
          REACT_APP_VIDEO_PLAYLIST: '[{"name":"100ms-360P","id":"video1","metadata":{"description":"100ms"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/100ms-360p.mp4","type":"video"},{"name":"100ms-720P","id":"video2","metadata":{"description":"100ms"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/100ms-720p.mp4","type":"video"},{"name":"Big Buck Bunny","id":"video3","metadata":{"description":"Bunny"},"url":"https://d2qi07yyjujoxr.cloudfront.net/webapp/playlist/video2.mp4","type":"video"}]'
          REACT_APP_HEADLESS_JOIN: false
          REACT_APP_ENABLE_STATS_FOR_NERDS: 'true'

      - name: Upload to Prod S3 Bucket
        if: github.ref == 'production'
        env:
          BUCKET: ${{ secrets.S3_BUCKET_PROD }}
        run: |
          aws s3 sync build s3://$BUCKET --include "static/*"
          aws s3 sync build s3://$BUCKET --exclude "static/*"
